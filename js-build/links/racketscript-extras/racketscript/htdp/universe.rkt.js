import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../../runtime/kernel.rkt.js";import * as M1 from "../../../racketscript-compiler/racketscript/interop.rkt.js";import * as M2 from "../private/jscommon.rkt.js";import * as M3 from "../../../racketscript-compiler/racketscript/private/interop.rkt.js";var __times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world951, handlers952) {return new BigBang(init_world951,handlers952);};var big_bang = $rjs_core.attachProcedureArity(function(init_world953, ...handlers954412) {var handlers954 = $rjs_core.Pair.listFromArray(handlers954412);return make_big_bang(init_world953,handlers954).setup().start();});var BigBang = function(init_world955, handlers956) {var this957 = this;this957.world = init_world955;this957.interval = 1000/__times_default_frames_per_second_times_;this957.handlers = handlers956;this957.__active_handlers = {};this957.__world_change_listeners = [];this957.__idle = true;this957.__stopped = true;this957.__events = [];return null;};BigBang.prototype.setup = function() {var this958 = this;var canvas959 = M2.document.createElement("canvas");var ctx960 = canvas959.getContext("2d");canvas959.setAttribute("tabindex",1);var let_result413 = M0.values();canvas959.setAttribute("style","outline: none");var let_result414 = M0.values();this958.__canvas = canvas959;var let_result415 = M0.values();this958.__context = ctx960;var let_result416 = M0.values();M2.document.body.appendChild(canvas959);var let_result417 = M0.values();canvas959.focus();var let_result418 = M0.values();this958.register_handlers();var let_result419 = M0.values();var draw_handler961 = this958.__active_handlers["to-draw"];if (draw_handler961!==false) {var if_res420 = M0.rvoid();} else {var if_res420 = M0.error($rjs_core.PrimitiveSymbol.make("big-bang"),$rjs_core.UString.make("to-draw handle not provided"));}if_res420;var let_result421 = M0.values();var img962 = draw_handler961.callback(this958.world);canvas959.width = img962.width;canvas959.height = img962.height;this958.change_world(this958.world);return this958;};BigBang.prototype.register_handlers = function() {var this963 = this;var active_handlers964 = this963.__active_handlers;var loop965 = function(handlers966) {if (M0.pair_p(handlers966)!==false) {var h967 = M0.car(handlers966)(this963);h967.register();active_handlers964[h967.name] = h967;var if_res422 = loop965(M0.cdr(handlers966));} else {var if_res422 = M0.rvoid();}return if_res422;};return loop965(this963.handlers);};BigBang.prototype.deregister_handlers = function() {var this968 = this;var active_handlers969 = this968.__active_handlers;return Object.keys(active_handlers969).forEach(function(key970) {var h971 = active_handlers969[key970];h971.deregister();active_handlers969[h971.name] = undefined;return null;});};BigBang.prototype.start = function() {var this972 = this;this972.__stopped = false;return this972.process_events();};BigBang.prototype.stop = function() {var this973 = this;this973.clear_event_queue();this973.__stopped = true;this973.__idle = true;this973.deregister_handlers();this973.__active_handlers = {};this973.handlers = $rjs_core.Pair.makeList();return null;};BigBang.prototype.clear_event_queue = function() {var this974 = this;return this974.__events.splice(0,this974.__events.length);};BigBang.prototype.queue_event = function(e975) {var this976 = this;this976.__events.push(e975);if (this976.__idle!==false) {var self977 = this976;var if_res423 = window.requestAnimationFrame(function() {return self977.process_events();});} else {var if_res423 = M0.rvoid();}return if_res423;};BigBang.prototype.change_world = function(new_world978) {var this979 = this;var listeners980 = this979.__world_change_listeners;var loop981 = function(i982) {if (M0.__lt_(i982,listeners980.length)!==false) {var listener983 = listeners980[i982];listener983(new_world978);var if_res424 = loop981(M0.add1(i982));} else {var if_res424 = M0.rvoid();}return if_res424;};loop981(0);this979.world = new_world978;return null;};BigBang.prototype.add_world_change_listener = function(cb984) {var this985 = this;return this985.__world_change_listeners.push(cb984);};BigBang.prototype.remove_world_change_listener = function(cb986) {var this987 = this;var index988 = this987.__world_change_listeners.indexOf(cb986);return this987.__world_change_listeners.splice(index988,1);};BigBang.prototype.process_events = function() {var this989 = this;var events990 = this989.__events;this989.__idle = false;var loop991 = function(world_changed_p992) {if (M0.__gt_(events990.length,0)!==false) {var evt993 = events990.shift();var handler994 = this989.__active_handlers[evt993.type];if (handler994!==false) {var if_res426 = handler994.invoke(this989.world,evt993);} else {if (M0.equal_p(evt993.type,"raw")!==false) {var if_res425 = evt993.invoke(this989.world,evt993);} else {var if_res425 = M2.console.warn($rjs_core.UString.make("ignoring unknown/unregistered event type: "),evt993);}var if_res426 = if_res425;}var changed_p995 = if_res426;var or_part996 = world_changed_p992;if (or_part996!==false) {var if_res427 = or_part996;} else {var if_res427 = changed_p995;}var if_res430 = loop991(if_res427);} else {if (world_changed_p992!==false) {var if_res428 = M0.not(this989.__stopped);} else {var if_res428 = false;}if (if_res428!==false) {this989.queue_event({'type':"to-draw"});var if_res429 = loop991(false);} else {var if_res429 = M0.rvoid();}var if_res430 = if_res429;}return if_res430;};loop991(false);this989.__idle = true;return null;};var to_draw = function(cb997) {return function(bb998) {var on_tick_evt999 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M0.rvoid();},'deregister':function() {return M0.rvoid();},'callback':cb997,'invoke':function(world1000, evt1001) {var ctx1002 = bb998.__context;var img1003 = cb997(bb998.world);var height1004 = img1003.height;var width1005 = img1003.width;ctx1002.clearRect(0,0,width1005,height1004);img1003.render(ctx1002,width1005/2,height1004/2);return false;}};};};var on_tick = function(cb1006, rate1007) {return function(bb1008) {var on_tick_evt1009 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {var this1010 = this;bb1008.queue_event(on_tick_evt1009);if (rate1007!==false) {rate1007 = 1000*rate1007;var if_res431 = null;} else {rate1007 = bb1008.interval;var if_res431 = null;}return if_res431;},'deregister':function() {var this1011 = this;var last_cb1012 = this1011.last_cb;if (last_cb1012!==false) {var if_res432 = window.clearTimeout(last_cb1012);} else {var if_res432 = M0.rvoid();}return if_res432;},'invoke':function(world1013, _1014) {var this1015 = this;bb1008.change_world(cb1006(world1013));this1015.last_cb = setTimeout(function() {return bb1008.queue_event(on_tick_evt1009);},rate1007);return true;}};};};var on_mouse = function(cb1016) {return function(bb1017) {return {'name':"on-mouse",'listeners':{},'register':function() {var this1018 = this;var canvas1019 = bb1017.__canvas;var make_listener1020 = function(r_evt_name1021) {return function(evt1022) {var posn1023 = canvas_posn_δ(canvas1019,evt1022);return bb1017.queue_event({'type':"on-mouse",'evt':M1.js_string__gt_string(r_evt_name1021),'x':posn1023.x,'y':posn1023.y});};};var register_listener1024 = function(evt_name1025, r_evt_name1026) {var cb1027 = make_listener1020(r_evt_name1026);canvas1019.addEventListener(evt_name1025,cb1027);this1018.listeners[evt_name1025] = cb1027;return null;};register_listener1024("mousemove","move");register_listener1024("mousedown","button-down");register_listener1024("mouseup","button-up");register_listener1024("mouseout","leave");register_listener1024("mouseover","enter");return register_listener1024("drag","drag");},'deregister':function() {var this1028 = this;var remove_listener1029 = function(evt_name1030) {var cb1031 = this1028.listeners[evt_name1030];return bb1017.__canvas.removeEventListener(evt_name1030,cb1031);};remove_listener1029("mousemove");remove_listener1029("mousedown");remove_listener1029("mouseup");remove_listener1029("mouseout");remove_listener1029("mouseover");return remove_listener1029("drag");},'invoke':function(world1032, evt1033) {var new_world1034 = cb1016(world1032,evt1033.x,evt1033.y,evt1033.evt);bb1017.change_world(new_world1034);return true;}};};};var on_key = function(cb1035) {return function(bb1036) {return {'name':"on-key",'register':function() {var this1037 = this;var canvas1038 = bb1036.__canvas;this1037.listener = function(evt1039) {evt1039.preventDefault();evt1039.stopPropagation();return bb1036.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt1039)});};return canvas1038.addEventListener("keydown",this1037.listener);},'deregister':function() {var this1040 = this;bb1036.__canvas.removeEventListener("keydown",this1040.listener);this1040.listener = undefined;return null;},'invoke':function(world1041, evt1042) {var new_world1043 = cb1035(world1041,evt1042.key);bb1036.change_world(new_world1043);return true;}};};};var on_release = function(cb1044) {return function(bb1045) {return {'name':"on-release",'register':function() {var this1046 = this;var canvas1047 = bb1045.__canvas;this1046.listener = function(evt1048) {evt1048.preventDefault();evt1048.stopPropagation();return bb1045.queue_event({'type':"on-release",'key':key_event__gt_key_name(evt1048)});};return canvas1047.addEventListener("keyup",this1046.listener);},'deregister':function() {var this1049 = this;bb1045.__canvas.removeEventListener("keyup",this1049.listener);this1049.listener = undefined;return null;},'invoke':function(world1050, evt1051) {var new_world1052 = cb1044(world1050,evt1051.key);bb1045.change_world(new_world1052);return true;}};};};var stop_when1053 = function(last_world_p21054, last_picture11055) {var last_world_p1056 = last_world_p21054;if (false!==false) {var if_res433 = false;} else {var if_res433 = last_picture11055;}var last_picture1057 = if_res433;return function(bb1058) {return {'name':"stop-when",'predicate':last_world_p1056,'lastpicture':last_picture1057,'register':function() {var this1059 = this;return bb1058.add_world_change_listener(this1059.invoke);},'deregister':function() {var this1060 = this;return bb1058.remove_world_change_listener(this1060.invoke);},'invoke':function(w1061) {if (last_world_p1056(w1061)!==false) {bb1058.stop();if (last_picture1057!==false) {var handler1062 = to_draw(last_picture1057)(bb1058);var if_res434 = bb1058.queue_event({'type':"raw",'invoke':handler1062.invoke});} else {var if_res434 = M0.rvoid();}var if_res435 = if_res434;} else {var if_res435 = M0.rvoid();}return if_res435;}};};};var cl436 = function(last_world_p1063) {return stop_when1053(last_world_p1063,false);};var cl437 = function(last_world_p1064, last_picture11065) {return stop_when1053(last_world_p1064,last_picture11065);};var stop_when = $rjs_core.attachProcedureArity(function() {var fixed_lam438 = {'1':cl436,'2':cl437}[arguments.length];if (fixed_lam438!==undefined) {return fixed_lam438.apply(null,arguments);} else {return M0.error($rjs_core.UString.make("case-lambda: invalid case"));}},[1,2]);var key_table = {'Backspace':$rjs_core.UString.make("\b"),'Enter':$rjs_core.UString.make("\r"),'Tab':$rjs_core.UString.make("\t"),'ArrowLeft':$rjs_core.UString.make("left"),'ArrowRight':$rjs_core.UString.make("right"),'ArrowDown':$rjs_core.UString.make("down"),'ArrowUp':$rjs_core.UString.make("up"),'Shift':$rjs_core.UString.make("shift"),'Control':$rjs_core.UString.make("control"),'ControlRight':$rjs_core.UString.make("rcontrol"),'ControlLeft':$rjs_core.UString.make("control"),'ShiftRight':$rjs_core.UString.make("rshift"),'ShiftLeft':$rjs_core.UString.make("shift"),'Escape':$rjs_core.UString.make("escape"),'Home':$rjs_core.UString.make("home"),'End':$rjs_core.UString.make("end"),'Insert':$rjs_core.UString.make("insert"),'Delete':$rjs_core.UString.make("\u007F"),'Pause':$rjs_core.UString.make("pause"),'NumLock':$rjs_core.UString.make("numlock"),'F1':$rjs_core.UString.make("f1"),'F2':$rjs_core.UString.make("f2"),'F3':$rjs_core.UString.make("f3"),'F4':$rjs_core.UString.make("f4"),'F5':$rjs_core.UString.make("f5"),'F6':$rjs_core.UString.make("f6"),'F7':$rjs_core.UString.make("f7"),'F8':$rjs_core.UString.make("f8"),'F9':$rjs_core.UString.make("f9"),'F10':$rjs_core.UString.make("f10"),'F11':$rjs_core.UString.make("f11"),'F12':$rjs_core.UString.make("f12")};var key_event__gt_key_name = function(e1066) {var k1067 = e1066.key;var or_part1069 = k1067==="Shift";if (or_part1069!==false) {var if_res440 = or_part1069;} else {var or_part1070 = k1067==="Control";if (or_part1070!==false) {var if_res439 = or_part1070;} else {var if_res439 = k1067==="Alt";}var if_res440 = if_res439;}if (if_res440!==false) {var if_res441 = e1066.code;} else {var if_res441 = k1067;}var code1068 = if_res441;var key_table_code1071 = key_table[code1068];if (M0.void_p(key_table_code1071)!==false) {var if_res442 = M1.js_string__gt_string(code1068);} else {var if_res442 = key_table_code1071;}return if_res442;};var canvas_posn_δ = function(canvas1072, evt1073) {var rect1074 = canvas1072.getBoundingClientRect();return {'x':evt1073.clientX-rect1074.left,'y':evt1073.clientY-rect1074.top};};var key_eq__p = function(k11075, k21076) {return M0.equal_p(k11075,k21076);};var mouse_eq__p = function(m11077, m21078) {return M0.equal_p(m11077,m21078);};var __rjs_quoted__ = {};__rjs_quoted__.key_event__gt_key_name = key_event__gt_key_name;export { __rjs_quoted__,mouse_eq__p,key_eq__p,big_bang,stop_when,to_draw,on_release,on_key,on_tick,on_mouse };